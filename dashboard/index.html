<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×˜×“ CRM - ×“×©×‘×•×¨×“</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0f;
      color: #e0e0e0;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      padding: 20px 30px;
      border-bottom: 1px solid #2a2a4a;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      font-size: 24px;
      color: #fff;
    }

    .header h1 span { color: #00d4aa; }

    .header .refresh-btn {
      background: #00d4aa;
      color: #0a0a0f;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }

    .header .refresh-btn:hover { background: #00f0c0; }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      padding: 20px 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #1a1a2e, #1e1e3a);
      border: 1px solid #2a2a4a;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .stat-card .number {
      font-size: 36px;
      font-weight: bold;
      color: #00d4aa;
    }

    .stat-card .label {
      font-size: 13px;
      color: #888;
      margin-top: 4px;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 0 30px 30px;
    }

    @media (max-width: 900px) {
      .main-content { grid-template-columns: 1fr; }
    }

    .panel {
      background: linear-gradient(135deg, #1a1a2e, #1e1e3a);
      border: 1px solid #2a2a4a;
      border-radius: 12px;
      overflow: hidden;
    }

    .panel-header {
      padding: 16px 20px;
      border-bottom: 1px solid #2a2a4a;
      font-size: 16px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-body {
      padding: 16px 20px;
      max-height: 500px;
      overflow-y: auto;
    }

    .panel-body::-webkit-scrollbar { width: 6px; }
    .panel-body::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    .activity-item {
      display: flex;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid #1a1a2e;
    }

    .activity-item:last-child { border-bottom: none; }

    .activity-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .activity-icon.note { background: #1e3a5f; }
    .activity-icon.reminder { background: #3a1e5f; }
    .activity-icon.interaction { background: #1e5f3a; }
    .activity-icon.tags { background: #5f3a1e; }
    .activity-icon.global_note { background: #3a3a1e; }

    .activity-content { flex: 1; }
    .activity-content .name { font-weight: bold; color: #00d4aa; font-size: 14px; }
    .activity-content .text { color: #ccc; font-size: 13px; margin-top: 2px; }
    .activity-content .time { color: #666; font-size: 11px; margin-top: 4px; }

    .contact-item {
      padding: 12px 0;
      border-bottom: 1px solid #1a1a2e;
    }

    .contact-item:last-child { border-bottom: none; }

    .contact-name {
      font-weight: bold;
      color: #fff;
      font-size: 15px;
    }

    .contact-phone {
      color: #666;
      font-size: 12px;
    }

    .contact-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    .tag {
      background: #00d4aa22;
      color: #00d4aa;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 11px;
      border: 1px solid #00d4aa44;
    }

    .contact-meta {
      color: #888;
      font-size: 12px;
      margin-top: 4px;
    }

    .contact-notes-count {
      color: #666;
      font-size: 11px;
    }

    .reminder-item {
      padding: 10px 0;
      border-bottom: 1px solid #1a1a2e;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .reminder-item:last-child { border-bottom: none; }

    .reminder-text { font-size: 14px; color: #ccc; }
    .reminder-due { font-size: 11px; color: #888; }

    .reminder-status {
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }

    .reminder-status.pending { background: #f0ad4e33; color: #f0ad4e; }
    .reminder-status.done { background: #00d4aa33; color: #00d4aa; }
    .reminder-status.cancelled { background: #ff444433; color: #ff4444; }

    .tags-panel .tag-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #1a1a2e;
    }

    .tags-panel .tag-name { color: #00d4aa; font-size: 14px; }
    .tags-panel .tag-count { color: #666; font-size: 13px; }

    .empty-state {
      text-align: center;
      color: #555;
      padding: 40px 20px;
      font-size: 14px;
    }

    .full-width { grid-column: 1 / -1; }

    .search-box {
      width: 100%;
      padding: 10px 16px;
      background: #0a0a15;
      border: 1px solid #2a2a4a;
      border-radius: 8px;
      color: #e0e0e0;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .search-box::placeholder { color: #555; }
    .search-box:focus { outline: none; border-color: #00d4aa; }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ¤– <span>×˜×“</span> CRM ×“×©×‘×•×¨×“</h1>
    <button class="refresh-btn" onclick="loadAll()">ğŸ”„ ×¨×¢× ×Ÿ</button>
  </div>

  <div class="stats-row" id="stats-row">
    <div class="stat-card"><div class="number" id="stat-contacts">-</div><div class="label">×× ×©×™ ×§×©×¨</div></div>
    <div class="stat-card"><div class="number" id="stat-notes">-</div><div class="label">×”×¢×¨×•×ª</div></div>
    <div class="stat-card"><div class="number" id="stat-reminders">-</div><div class="label">×ª×–×›×•×¨×•×ª ×¤×¢×™×œ×•×ª</div></div>
    <div class="stat-card"><div class="number" id="stat-due">-</div><div class="label">×ª×–×›×•×¨×•×ª ×©×”×’×™×¢ ×”×–××Ÿ</div></div>
    <div class="stat-card"><div class="number" id="stat-tags">-</div><div class="label">×ª×’×™×•×ª</div></div>
  </div>

  <div class="main-content">
    <!-- Activity Feed -->
    <div class="panel">
      <div class="panel-header">ğŸ“‹ ×¤×¢×™×œ×•×ª ××—×¨×•× ×”</div>
      <div class="panel-body" id="activity-feed">
        <div class="empty-state">×˜×•×¢×Ÿ...</div>
      </div>
    </div>

    <!-- Contacts -->
    <div class="panel">
      <div class="panel-header">ğŸ‘¥ ×× ×©×™ ×§×©×¨</div>
      <div class="panel-body">
        <input type="text" class="search-box" placeholder="ğŸ” ×—×¤×© ××™×© ×§×©×¨..." oninput="filterContacts(this.value)">
        <div id="contacts-list">
          <div class="empty-state">×˜×•×¢×Ÿ...</div>
        </div>
      </div>
    </div>

    <!-- Reminders -->
    <div class="panel">
      <div class="panel-header">â° ×ª×–×›×•×¨×•×ª</div>
      <div class="panel-body" id="reminders-list">
        <div class="empty-state">×˜×•×¢×Ÿ...</div>
      </div>
    </div>

    <!-- Tags -->
    <div class="panel tags-panel">
      <div class="panel-header">ğŸ·ï¸ ×ª×’×™×•×ª</div>
      <div class="panel-body" id="tags-list">
        <div class="empty-state">×˜×•×¢×Ÿ...</div>
      </div>
    </div>
  </div>

  <script>
    let allContacts = [];

    const ICONS = {
      note: 'ğŸ“',
      reminder: 'â°',
      interaction: 'ğŸ’¬',
      tags: 'ğŸ·ï¸',
      global_note: 'ğŸ“Œ',
    };

    function formatDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      const now = new Date();
      const diff = now - d;

      if (diff < 60000) return '×”×¨×’×¢';
      if (diff < 3600000) return `×œ×¤× ×™ ${Math.floor(diff / 60000)} ×“×§'`;
      if (diff < 86400000) return `×œ×¤× ×™ ${Math.floor(diff / 3600000)} ×©×¢×•×ª`;
      if (diff < 604800000) return `×œ×¤× ×™ ${Math.floor(diff / 86400000)} ×™××™×`;

      return d.toLocaleDateString('he-IL', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function formatPhone(jid) {
      if (!jid) return '';
      return jid.replace('@s.whatsapp.net', '').replace('@g.us', ' (×§×‘×•×¦×”)');
    }

    async function loadStats() {
      try {
        const res = await fetch('/api/stats');
        const stats = await res.json();
        document.getElementById('stat-contacts').textContent = stats.total_contacts;
        document.getElementById('stat-notes').textContent = stats.total_notes;
        document.getElementById('stat-reminders').textContent = stats.pending_reminders;
        document.getElementById('stat-due').textContent = stats.due_reminders;
        document.getElementById('stat-tags').textContent = stats.tags?.length || 0;
      } catch (e) {
        console.error('Failed to load stats:', e);
      }
    }

    async function loadActivity() {
      try {
        const res = await fetch('/api/activity');
        const log = await res.json();
        const el = document.getElementById('activity-feed');

        if (log.length === 0) {
          el.innerHTML = '<div class="empty-state">××™×Ÿ ×¤×¢×™×œ×•×ª ×¢×“×™×™×Ÿ.<br>×”×ª×—×œ ×œ×”×©×ª××© ×‘×˜×“ ×•×ª×¨××” ×›××Ÿ ××ª ×”×”×™×¡×˜×•×¨×™×”!</div>';
          return;
        }

        el.innerHTML = log.slice(0, 50).map(item => `
          <div class="activity-item">
            <div class="activity-icon ${item.type}">${ICONS[item.type] || 'ğŸ“Œ'}</div>
            <div class="activity-content">
              ${item.contact_name ? `<div class="name">${item.contact_name}</div>` : ''}
              <div class="text">${item.text}</div>
              <div class="time">${formatDate(item.timestamp)}</div>
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.error('Failed to load activity:', e);
      }
    }

    async function loadContacts() {
      try {
        const res = await fetch('/api/crm');
        const crm = await res.json();
        allContacts = Object.values(crm.contacts || {});
        renderContacts(allContacts);
      } catch (e) {
        console.error('Failed to load contacts:', e);
      }
    }

    function renderContacts(contacts) {
      const el = document.getElementById('contacts-list');

      if (contacts.length === 0) {
        el.innerHTML = '<div class="empty-state">××™×Ÿ ×× ×©×™ ×§×©×¨ ×‘-CRM ×¢×“×™×™×Ÿ.<br>×××•×¨ ×œ×˜×“ "×ª×ª×™×™×’ ××ª X ×›×—×‘×¨" ×œ×”×ª×—×™×œ!</div>';
        return;
      }

      // Sort by updated_at desc
      contacts.sort((a, b) => (b.updated_at || '').localeCompare(a.updated_at || ''));

      el.innerHTML = contacts.map(c => `
        <div class="contact-item">
          <div class="contact-name">${c.name || formatPhone(c.jid)}</div>
          <div class="contact-phone">${formatPhone(c.jid)}</div>
          ${c.tags?.length ? `
            <div class="contact-tags">
              ${c.tags.map(t => `<span class="tag">${t}</span>`).join('')}
            </div>
          ` : ''}
          ${Object.keys(c.metadata || {}).length ? `
            <div class="contact-meta">
              ${Object.entries(c.metadata).map(([k, v]) => `${k}: ${v}`).join(' | ')}
            </div>
          ` : ''}
          ${c.notes?.length ? `<div class="contact-notes-count">ğŸ“ ${c.notes.length} ×”×¢×¨×•×ª</div>` : ''}
          ${c.follow_up_date ? `<div class="contact-meta">ğŸ“… ×¤×•×œ×•××¤: ${c.follow_up_date}</div>` : ''}
          ${c.last_interaction ? `<div class="contact-meta">ğŸ’¬ ××™× ×˜×¨××§×¦×™×” ××—×¨×•× ×”: ${formatDate(c.last_interaction)}</div>` : ''}
        </div>
      `).join('');
    }

    function filterContacts(query) {
      if (!query) {
        renderContacts(allContacts);
        return;
      }
      const q = query.toLowerCase();
      const filtered = allContacts.filter(c =>
        (c.name || '').toLowerCase().includes(q) ||
        (c.jid || '').includes(q) ||
        (c.tags || []).some(t => t.includes(q)) ||
        Object.values(c.metadata || {}).some(v => v.toLowerCase().includes(q))
      );
      renderContacts(filtered);
    }

    async function loadReminders() {
      try {
        const res = await fetch('/api/crm');
        const crm = await res.json();
        const reminders = crm.reminders || [];
        const el = document.getElementById('reminders-list');

        if (reminders.length === 0) {
          el.innerHTML = '<div class="empty-state">××™×Ÿ ×ª×–×›×•×¨×•×ª.<br>×××•×¨ ×œ×˜×“ "×ª×–×›×™×¨ ×œ×™ ××—×¨..." ×œ×”×•×¡×™×£!</div>';
          return;
        }

        // Sort: pending first, then by due date
        reminders.sort((a, b) => {
          if (a.status === 'pending' && b.status !== 'pending') return -1;
          if (a.status !== 'pending' && b.status === 'pending') return 1;
          return (a.due_at || '').localeCompare(b.due_at || '');
        });

        el.innerHTML = reminders.map(r => `
          <div class="reminder-item">
            <div>
              <div class="reminder-text">${r.text}</div>
              <div class="reminder-due">ğŸ“… ${r.due_at ? new Date(r.due_at).toLocaleString('he-IL') : '×œ×œ× ×ª××¨×™×š'}</div>
            </div>
            <span class="reminder-status ${r.status}">${r.status === 'pending' ? '×××ª×™×Ÿ' : r.status === 'done' ? '×‘×•×¦×¢' : '×‘×•×˜×œ'}</span>
          </div>
        `).join('');
      } catch (e) {
        console.error('Failed to load reminders:', e);
      }
    }

    async function loadTags() {
      try {
        const res = await fetch('/api/stats');
        const stats = await res.json();
        const tags = stats.tags || [];
        const el = document.getElementById('tags-list');

        if (tags.length === 0) {
          el.innerHTML = '<div class="empty-state">××™×Ÿ ×ª×’×™×•×ª ×¢×“×™×™×Ÿ.<br>×××•×¨ ×œ×˜×“ "×ª×ª×™×™×’ ××ª X ×›-friend" ×œ×”×ª×—×™×œ!</div>';
          return;
        }

        el.innerHTML = tags.map(t => `
          <div class="tag-row">
            <span class="tag-name">ğŸ·ï¸ ${t.tag}</span>
            <span class="tag-count">${t.count} ×× ×©×™ ×§×©×¨</span>
          </div>
        `).join('');
      } catch (e) {
        console.error('Failed to load tags:', e);
      }
    }

    function loadAll() {
      loadStats();
      loadActivity();
      loadContacts();
      loadReminders();
      loadTags();
    }

    // Auto-refresh every 30 seconds
    loadAll();
    setInterval(loadAll, 30000);
  </script>
</body>
</html>
